"""
Workflow purpose
----------------
Combine results from different workflows for publication.

"""

import os
import pandas as pd

##### VARIABLES #####
ROOT = os.path.dirname(os.path.dirname(os.getcwd()))
DATA_DIR = os.path.join(ROOT,'data')
RAW_DIR = os.path.join(DATA_DIR,'raw')
PREP_DIR = os.path.join(DATA_DIR,'prep')
RESULTS_DIR = os.path.join(ROOT,'results')

MODEL_SEL_DIR = os.path.join(RESULTS_DIR,"model_splicing_dependency","figures","model_selection","figdata")
MODEL_VAL_THOMAS_DIR = os.path.join(RESULTS_DIR,"model_splicing_dependency","figures","validation_crispr_screen","Thomas2020","figdata")
MODEL_VAL_GONATO_DIR = os.path.join(RESULTS_DIR,"model_splicing_dependency","figures","validation_crispr_screen","Gonatopoulos-Pournatzis2020","figdata")
MODEL_VAL_ENCORE = os.path.join(RESULTS_DIR,"model_splicing_dependency","figures","validation_encore","figdata")
TARGET_VAL_TCGA = os.path.join(RESULTS_DIR,"streamlined_therapy_dev","figures","targetable_events","figdata")
TARGET_VAL_EXP = os.path.join(RESULTS_DIR,"experimental_validation","figures","validation","figdata")
MODEL_DRUG_SENS_DIR = os.path.join(RESULTS_DIR,"exon_drug_interactions","figures","model_drug_screens","figdata")

##### RULES #####
rule all:
    input:
        os.path.join(RESULTS_DIR,'prepare_publication','files','supplementary_tables')

rule supplementary_tables:
    input:
        # model cancer-driver exons
        ## CCLE RNAi - demeter2
        suptab01_ccle_demeter2 = os.path.join(PREP_DIR,"demeter2","CCLE.tsv.gz"),
        ## CCLE tpm
        suptab02_ccle_tpm = os.path.join(PREP_DIR,"genexpr_tpm","CCLE.tsv.gz"),
        ## CCLE psi
        suptab03_ccle_psi = os.path.join(PREP_DIR,"event_psi","CCLE-EX.tsv.gz"),
        ## CCLE metadata
        suptab04_ccle_metadata = os.path.join(PREP_DIR,"metadata","CCLE.tsv.gz"),
        ## model summaries
        suptab05_model_summaries = os.path.join(MODEL_SEL_DIR,"model_selection","model_summaries.tsv.gz"),
        ## rnai stats
        suptab06_rnai_stats = os.path.join(MODEL_SEL_DIR,"model_selection","rnai_stats.tsv.gz"),
        ## known cancer-driver events
        suptab07_cancer_events = os.path.join(MODEL_SEL_DIR,"model_selection","cancer_events.tsv.gz"),
        ## lr-tests thresholds
        suptab08_evaluation_pvalue = os.path.join(MODEL_SEL_DIR,"model_selection","evaluation_pvalue.tsv.gz"),
        ## pearson thresholds
        suptab09_evaluation_correlation = os.path.join(MODEL_SEL_DIR,"model_selection","evaluation_correlation.tsv.gz"),
        ## gsoa
        suptab10_gsoa = os.path.join(MODEL_SEL_DIR,"model_properties","gsoa_selected.tsv.gz"),
        ## gene-level mutation frequency
        suptab11_gene_mut_freq = os.path.join(MODEL_SEL_DIR,"model_validation","gene_mutation_frequency.tsv.gz"),
        ## splicing dependency CCLE
        suptab12_spldep_ccle = os.path.join(RESULTS_DIR,"model_splicing_dependency","files","splicing_dependency-EX","mean.tsv.gz"),
        ## splicing dependency summary stats
        suptab14_spldep_stats = os.path.join(MODEL_SEL_DIR,"model_properties","splicing_dependecy_stats.tsv.gz"),
        
        # model validation
        ## Thomas - observed changes in cell proliferation
        suptab15_thomas_crispr_screen = os.path.join(MODEL_VAL_THOMAS_DIR,"model_validation","crispr_screen.tsv.gz"),
        ## Thomas - spotter results
        suptab16_thomas_spotter_results = os.path.join(MODEL_VAL_THOMAS_DIR,"model_validation","spotter_results.tsv.gz"),
        ## Gonatopoulos - observed changes in cell proliferation
        suptab17_thomas_crispr_screen = os.path.join(MODEL_VAL_GONATO_DIR,"model_validation","crispr_screen.tsv.gz"),
        ## Gonatopoulos - spotter results
        suptab18_thomas_spotter_results = os.path.join(MODEL_VAL_GONATO_DIR,"model_validation","spotter_results.tsv.gz"),
        ## ENCORE - PSI
        suptab19_encore_psi = os.path.join(PREP_DIR,'event_psi','ENCORE-EX.tsv.gz'),
        ## ENCORE - TPM
        suptab20_encore_tpm = os.path.join(PREP_DIR,'genexpr_tpm','ENCORE.tsv.gz'),
        ## ENCORE - metadata
        suptab21_encore_metadata = os.path.join(PREP_DIR,'metadata','ENCORE.tsv.gz'),
        ## ENCORE - spotter results
        suptab22_encore_spotter_results = os.path.join(MODEL_VAL_ENCORE,"model_validation","spotter_results.tsv.gz"),
        ## ENCORE - correlation tables
        suptab23_encore_evaluation = os.path.join(MODEL_VAL_ENCORE,"model_validation","evaluation.tsv.gz"),
        
        # streamlined drug development
        ## TCGA - PSI (not as sup. tab.)
        ## TCGA - mRNA level counts (not as sup. tab.)
        ## TCGA - Differential Splicing, Spl. Dep., Harm Score
        suptab24_targetable_exons_cancer_types = os.path.join(TARGET_VAL_TCGA,"targetable_events","differential_analysis-by_cancer_type.tsv.gz"),
        suptab25_targetable_exons_cancer_subtypes = os.path.join(TARGET_VAL_TCGA,"targetable_events","differential_analysis-by_cancer_subtype.tsv.gz"),
        ## SSO - sequences SSO
        #suptab26_targetable_exons_sso_sequences = ""
        ## SSO - sequences primers
        #suptab27_targetable_exons_primer_sequences = ""
        ## SSO - cancer cells RNA-seq: PSI, TPM, Spl. Dep., Harm Score (TODO)
        suptab28_targetable_exons_spotter_results = os.path.join(TARGET_VAL_EXP,"experiments","validation_harm_scores.tsv.gz"),
        ## SSO - cell proliferation experiments
        suptab29_targetable_exons_clonogenic_assays = os.path.join(TARGET_VAL_EXP,"experiments","validation_clonogenic.tsv.gz"),
        
        # drug-exon mechanistic interactions
        ## GDSC - drug sensitivities (training + test)
        suptab30_drug_sensitivites = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','drug_sensitivities.tsv.gz'),
        ## GDSC - drug target info
        suptab31_drug_targets = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','drug_targets.tsv.gz'),
        ## drug-exon - model summaries
        suptab32_drug_exon_associations = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','model_summaries.tsv.gz'),
        ## drug-exon - ReactomeDB pathway tests
        suptab33_evaluation_reactome_pathways = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','evaluation_reactome.tsv.gz'),
        ## drug-exon - shortest path lengths
        suptab33_evaluation_stringdb_ppi = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','shortest_paths.tsv.gz'),
        ## nutlin - stability analysis (structures? + results) (not as sup tab)
        ## nutlin - PSI MDM4 vs TPM TP53 in CCLE
        suptab33_example_mdm4_tp53 = os.path.join(MODEL_DRUG_SENS_DIR,'drug_event_assoc','example_mdm4.tsv.gz'),
        
        # treatment recommendation
        ## GDSC - correlations training and test sets
        ## Pietilla - PSI
        ## Pietilla - TPM
        ## Pietilla - Spl. Dep.
        ## Pietilla - Pred. IC50
        ## Pietilla - Metadata
        ## Pietilla - ROC analysis
        
    output:
        directory(os.path.join(RESULTS_DIR,'prepare_publication','files','supplementary_tables'))
    run:
        import os
        import subprocess
        
        outdir = output[0]
        os.makedirs(outdir, exist_ok=True)
        
        for key, f in input.items():
            filename = os.path.basename(f)
            outfile = os.path.join(outdir,key+"-"+filename)
            cmd = ["cp", f, outfile]
            print(cmd)
            subprocess.call(cmd)
            
        print("Done!")